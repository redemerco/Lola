<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RenzoGPT</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --sidebar-bg:#171717;
  --sidebar-hover:#2f2f2f;
  --sidebar-border:#2e2e2e;
  --main-bg:#212121;
  --input-bg:#2f2f2f;
  --input-border:#424242;
  --text-primary:#ececec;
  --text-secondary:#9b9b9b;
  --text-muted:#6b6b6b;
  --user-bubble:#2f2f2f;
  --accent:#10a37f;
  --accent-hover:#1a7f64;
  --code-bg:#1e1e1e;
  --code-border:#333;
  --scrollbar:#424242;
  --scrollbar-hover:#555;
  --sidebar-width:260px;
  --msg-max-width:680px;
}
html,body{height:100%;overflow:hidden}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background:var(--main-bg);color:var(--text-primary);display:flex;
}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--scrollbar-hover)}
button{cursor:pointer;border:none;background:none;color:inherit;font:inherit}
a{color:var(--accent);text-decoration:none}

/* ─── SIDEBAR ─── */
.sidebar{
  width:var(--sidebar-width);min-width:var(--sidebar-width);height:100%;
  background:var(--sidebar-bg);display:flex;flex-direction:column;
  transition:transform .2s ease,opacity .2s ease;z-index:100;
}
.sidebar.hidden{transform:translateX(-100%);opacity:0;position:absolute;pointer-events:none}
.sidebar-header{padding:12px 12px 0}
.new-chat-btn{
  width:100%;display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:8px;font-size:14px;color:var(--text-primary);
  transition:background .15s;
}
.new-chat-btn:hover{background:var(--sidebar-hover)}
.new-chat-btn svg{width:18px;height:18px;flex-shrink:0}
.sidebar-chats{flex:1;overflow-y:auto;padding:8px 8px 0;display:flex;flex-direction:column;gap:1px}
.chat-item{
  padding:10px 12px;border-radius:8px;font-size:13.5px;
  color:var(--text-secondary);cursor:pointer;transition:background .15s;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative;
}
.chat-item:hover{background:var(--sidebar-hover);color:var(--text-primary)}
.chat-item.active{background:var(--sidebar-hover);color:var(--text-primary)}
.chat-item .delete-chat{
  position:absolute;right:8px;top:50%;transform:translateY(-50%);
  opacity:0;transition:opacity .15s;padding:4px;border-radius:4px;
}
.chat-item:hover .delete-chat{opacity:1}
.chat-item .delete-chat:hover{background:rgba(255,255,255,.1)}
.sidebar-footer{
  padding:12px;border-top:1px solid var(--sidebar-border);
  display:flex;align-items:center;gap:10px;
}
.user-avatar{
  width:32px;height:32px;border-radius:50%;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:600;flex-shrink:0;
}
.user-info{overflow:hidden}
.user-name{font-size:13.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ─── MAIN ─── */
.main{flex:1;display:flex;flex-direction:column;height:100%;min-width:0;position:relative}
.main-header{
  display:flex;align-items:center;padding:12px 16px;gap:8px;
  position:sticky;top:0;z-index:10;
}
.menu-btn{
  display:none;padding:8px;border-radius:8px;transition:background .15s;
}
.menu-btn:hover{background:var(--sidebar-hover)}
.menu-btn svg{width:20px;height:20px}
.model-label{
  font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px;
}

/* ─── MESSAGES ─── */
.messages{
  flex:1;overflow-y:auto;padding:0 16px 24px;
  display:flex;flex-direction:column;scroll-behavior:smooth;
}
.messages-inner{
  max-width:var(--msg-max-width);width:100%;margin:0 auto;
  display:flex;flex-direction:column;gap:4px;
}
.welcome{
  flex:1;display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:16px;min-height:60vh;
}
.welcome-logo{
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),#0d8c6d);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:700;
}
.welcome-title{font-size:22px;font-weight:600}
.welcome-sub{color:var(--text-secondary);font-size:14px}

.message{
  padding:16px 0;display:flex;gap:16px;
  animation:msgIn .3s ease;line-height:1.6;
}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.message.user{justify-content:flex-end;flex-direction:column;align-items:flex-end}
.message.user .msg-content{
  background:var(--user-bubble);padding:12px 16px;
  border-radius:18px 18px 4px 18px;max-width:85%;
}
.message.user .msg-attachments{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-bottom:4px}
.message.assistant{flex-direction:row;align-items:flex-start}
.msg-avatar{
  width:28px;height:28px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),#0d8c6d);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;margin-top:2px;
}
.msg-body{flex:1;min-width:0;max-width:100%}
.msg-content{font-size:15px;word-wrap:break-word;overflow-wrap:break-word}
.msg-content p{margin:0 0 12px}
.msg-content p:last-child{margin-bottom:0}
.msg-content strong{font-weight:600}
.msg-content em{font-style:italic}
.msg-content code{
  background:var(--code-bg);padding:2px 6px;border-radius:4px;
  font-family:'SF Mono','Fira Code','Cascadia Code',monospace;font-size:13px;
}
.msg-content pre{
  background:var(--code-bg);border:1px solid var(--code-border);
  border-radius:8px;padding:16px;margin:12px 0;overflow-x:auto;
  position:relative;
}
.msg-content pre code{background:none;padding:0;font-size:13px;line-height:1.5}
.msg-content ul,.msg-content ol{margin:8px 0;padding-left:24px}
.msg-content li{margin:4px 0}
.msg-content blockquote{
  border-left:3px solid var(--accent);padding-left:16px;
  margin:12px 0;color:var(--text-secondary);
}
.msg-actions{
  display:flex;gap:4px;margin-top:8px;opacity:0;transition:opacity .15s;
}
.message.assistant:hover .msg-actions{opacity:1}
.msg-action-btn{
  padding:6px;border-radius:6px;transition:background .15s;
  color:var(--text-muted);
}
.msg-action-btn:hover{background:var(--sidebar-hover);color:var(--text-primary)}
.msg-action-btn svg{width:16px;height:16px}
.msg-action-btn.copied{color:var(--accent)}

/* Attached images in messages */
.msg-img{
  max-width:240px;max-height:200px;border-radius:12px;
  object-fit:cover;cursor:pointer;transition:opacity .15s;
}
.msg-img:hover{opacity:.85}
.msg-file{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--sidebar-hover);padding:8px 12px;border-radius:10px;
  font-size:13px;color:var(--text-secondary);
}
.msg-file svg{width:16px;height:16px;flex-shrink:0}

/* Thinking indicator */
.thinking{display:flex;align-items:center;gap:4px;padding:4px 0}
.thinking-dot{
  width:6px;height:6px;border-radius:50%;background:var(--text-muted);
  animation:pulse 1.4s ease-in-out infinite;
}
.thinking-dot:nth-child(2){animation-delay:.2s}
.thinking-dot:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
.thinking-text{font-size:13px;color:var(--text-muted);margin-left:8px;font-style:italic}

/* ─── INPUT ─── */
.input-area{padding:0 16px 20px}
.input-wrapper{max-width:var(--msg-max-width);margin:0 auto}

/* Attachment preview */
.attach-preview{
  display:flex;gap:8px;flex-wrap:wrap;padding:0 0 8px;
}
.attach-preview:empty{display:none}
.attach-item{
  position:relative;display:inline-flex;animation:msgIn .2s ease;
}
.attach-item img{
  width:64px;height:64px;object-fit:cover;border-radius:10px;
  border:1px solid var(--input-border);
}
.attach-item .attach-file{
  display:flex;align-items:center;gap:6px;
  background:var(--sidebar-hover);padding:8px 12px;border-radius:10px;
  font-size:12px;color:var(--text-secondary);max-width:160px;
}
.attach-item .attach-file span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.attach-remove{
  position:absolute;top:-6px;right:-6px;
  width:20px;height:20px;border-radius:50%;
  background:#ef4444;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;line-height:1;
  transition:transform .1s;
}
.attach-remove:hover{transform:scale(1.15)}

.input-box{
  background:var(--input-bg);border:1px solid var(--input-border);
  border-radius:16px;padding:12px 16px;
  display:flex;align-items:flex-end;gap:8px;
  transition:border-color .15s;
}
.input-box:focus-within{border-color:var(--text-muted)}
.input-box textarea{
  flex:1;background:none;border:none;outline:none;
  color:var(--text-primary);font-size:15px;line-height:1.5;
  resize:none;max-height:200px;min-height:24px;
  font-family:inherit;
}
.input-box textarea::placeholder{color:var(--text-muted)}

.input-btn{
  width:32px;height:32px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  transition:background .15s,opacity .15s,transform .1s;
  color:var(--text-muted);
}
.input-btn:hover{background:var(--sidebar-hover);color:var(--text-primary)}
.input-btn:active{transform:scale(.92)}
.input-btn svg{width:18px;height:18px}

.send-btn{
  background:var(--text-primary);color:var(--main-bg);
  opacity:.3;
}
.send-btn:hover{background:var(--text-primary);color:var(--main-bg)}
.send-btn.active{opacity:1}
.send-btn.active:hover{background:#fff}
.send-btn svg{width:16px;height:16px}

.input-footer{
  display:flex;align-items:center;justify-content:center;gap:8px;
  padding-top:8px;font-size:11.5px;color:var(--text-muted);
}

/* ─── STATUS PANEL ─── */
.status-toggle{
  display:inline-flex;align-items:center;gap:4px;
  cursor:pointer;user-select:none;
  font-size:10.5px;color:var(--text-muted);
  transition:color .15s;
}
.status-toggle:hover{color:var(--text-secondary)}
.status-toggle svg{
  width:10px;height:10px;transition:transform .2s;
}
.status-toggle.open svg{transform:rotate(180deg)}
.status-panel{
  max-width:var(--msg-max-width);margin:0 auto;
  max-height:0;overflow:hidden;
  transition:max-height .25s ease,opacity .2s ease;
  opacity:0;
}
.status-panel.open{
  max-height:300px;opacity:1;margin-top:6px;
}
.status-grid{
  display:grid;gap:3px 8px;
  grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
}
.status-pill{
  display:flex;align-items:center;gap:5px;
  font-size:10px;color:var(--text-muted);
  background:var(--input-bg);border:1px solid var(--input-border);
  border-radius:6px;padding:3px 8px;
  font-family:'SF Mono','Fira Code',monospace;
  white-space:nowrap;
}
.status-dot{
  width:5px;height:5px;border-radius:50%;flex-shrink:0;
}
.status-dot.green{background:#22c55e}
.status-dot.yellow{background:#eab308}
.status-dot.red{background:#ef4444}
.status-pill .s-model{color:var(--text-secondary);flex:1}
.status-pill .s-detail{color:var(--text-muted);margin-left:auto}

/* Hidden file input */
#fileInput{display:none}

/* ─── COMMAND CONFIRM ─── */
.cmd-confirm{
  background:#1e1e1e;border:1px solid var(--accent);border-radius:12px;
  padding:16px;margin:8px 0;max-width:100%;
}
.cmd-confirm-title{
  font-size:13px;color:var(--text-secondary);margin-bottom:10px;
  display:flex;align-items:center;gap:6px;
}
.cmd-confirm-code{
  background:#0d0d0d;border:1px solid var(--code-border);border-radius:8px;
  padding:12px 14px;font-family:'SF Mono','Fira Code',monospace;font-size:13.5px;
  color:#e0e0e0;margin-bottom:14px;overflow-x:auto;white-space:pre;
}
.cmd-confirm-btns{display:flex;gap:8px}
.cmd-btn{
  padding:8px 20px;border-radius:8px;font-size:13.5px;font-weight:500;
  transition:background .15s,transform .1s;
}
.cmd-btn:active{transform:scale(.96)}
.cmd-btn-exec{background:#16a34a;color:#fff}
.cmd-btn-exec:hover{background:#15803d}
.cmd-btn-cancel{background:#3f3f46;color:var(--text-primary)}
.cmd-btn-cancel:hover{background:#52525b}
.cmd-output{
  background:#0d0d0d;border:1px solid var(--code-border);border-radius:8px;
  padding:12px 14px;font-family:'SF Mono','Fira Code',monospace;font-size:12.5px;
  color:#a3e635;margin:8px 0;overflow-x:auto;white-space:pre-wrap;
  max-height:300px;overflow-y:auto;
}

/* ─── OVERLAY ─── */
.sidebar-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;
}

/* ─── MOBILE ─── */
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;height:100%}
  .sidebar.hidden{transform:translateX(-100%)}
  .menu-btn{display:flex}
  .sidebar-overlay.show{display:block}
  .messages-inner{padding:0 4px}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar hidden" id="sidebar">
  <div class="sidebar-header">
    <button class="new-chat-btn" onclick="newChat()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
      Nuevo chat
    </button>
  </div>
  <div class="sidebar-chats" id="chatList"></div>
  <div class="sidebar-footer">
    <div class="user-avatar">R</div>
    <div class="user-info">
      <div class="user-name">Renzo</div>
    </div>
  </div>
</aside>
<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- MAIN -->
<div class="main">
  <div class="main-header">
    <button class="menu-btn" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </button>
    <div class="model-label">
      RenzoGPT
      <svg width="12" height="12" viewBox="0 0 12 12" fill="var(--text-muted)"><path d="M3 4.5l3 3 3-3"/></svg>
    </div>
  </div>

  <div class="messages" id="messages">
    <div class="messages-inner" id="messagesInner">
      <div class="welcome" id="welcome">
        <div class="welcome-logo">R</div>
        <div class="welcome-title">¿En qué puedo ayudarte?</div>
        <div class="welcome-sub">Escribí lo que necesites.</div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <div class="attach-preview" id="attachPreview"></div>
      <div class="input-box">
        <!-- Clip / attach button -->
        <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Adjuntar archivo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.webp,.heic,.pdf,.txt,.csv,.json,.md,.py,.js,.ts,.html,.css" onchange="handleFiles(this.files)">
        <textarea id="input" rows="1" placeholder="Enviar un mensaje a RenzoGPT" oninput="autoGrow(this);toggleSend()"></textarea>
        <!-- Send button -->
        <button class="input-btn send-btn" id="sendBtn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
      </div>
      <div class="input-footer" id="modelInfo">
        Conectando...
        <span class="status-toggle" id="statusToggle" onclick="toggleStatus()">
          <svg viewBox="0 0 12 12" fill="currentColor"><path d="M2 4.5l4 4 4-4"/></svg>
          Keys
        </span>
      </div>
      <div class="status-panel" id="statusPanel">
        <div class="status-grid" id="statusGrid"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ─── STATE ───
let chats = JSON.parse(localStorage.getItem('renzogpt-chats') || '[]');
let activeChatId = null;
let isGenerating = false;
let pendingFiles = []; // {name, type, dataUrl, base64}

// ─── INIT ───
function init() {
  if (chats.length > 0) {
    activeChatId = chats[0].id;
    renderSidebar();
    renderMessages();
    toggleSidebar();
  }
  const input = document.getElementById('input');
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  // Drag & drop
  const main = document.querySelector('.main');
  main.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
  main.addEventListener('drop', e => { e.preventDefault(); handleFiles(e.dataTransfer.files); });
  // Paste images
  document.addEventListener('paste', e => {
    const items = e.clipboardData?.items;
    if (!items) return;
    const files = [];
    for (const item of items) {
      if (item.kind === 'file') files.push(item.getAsFile());
    }
    if (files.length) handleFiles(files);
  });
}

// ─── STORAGE ───
function save() { localStorage.setItem('renzogpt-chats', JSON.stringify(chats)); }
function activeChat() { return chats.find(c => c.id === activeChatId); }

// ─── SIDEBAR ───
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('hidden');
  document.getElementById('overlay').classList.toggle('show');
}

function renderSidebar() {
  document.getElementById('chatList').innerHTML = chats.map(c => `
    <div class="chat-item ${c.id === activeChatId ? 'active' : ''}" onclick="switchChat('${c.id}')">
      ${esc(c.title || 'Nuevo chat')}
      <button class="delete-chat" onclick="event.stopPropagation();deleteChat('${c.id}')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14"/></svg>
      </button>
    </div>
  `).join('');
}

// ─── CHAT MANAGEMENT ───
function newChat() {
  const chat = { id: Date.now().toString(), title: '', messages: [] };
  chats.unshift(chat);
  activeChatId = chat.id;
  pendingFiles = [];
  renderAttachPreview();
  save(); renderSidebar(); renderMessages();
  if (window.innerWidth <= 768) toggleSidebar();
  document.getElementById('input').focus();
}

function switchChat(id) {
  activeChatId = id;
  pendingFiles = [];
  renderAttachPreview();
  renderSidebar(); renderMessages();
  if (window.innerWidth <= 768) toggleSidebar();
}

function deleteChat(id) {
  chats = chats.filter(c => c.id !== id);
  if (activeChatId === id) activeChatId = chats.length ? chats[0].id : null;
  save(); renderSidebar(); renderMessages();
}

// ─── FILE HANDLING ───
const SUPPORTED_IMAGES = ['image/jpeg','image/png','image/gif','image/webp','image/heic','image/heif'];
const SUPPORTED_DOCS = ['application/pdf','text/plain','text/csv','text/html','text/css','text/javascript','application/json','text/markdown'];
function handleFiles(fileList) {
  for (const file of fileList) {
    if (file.size > 20 * 1024 * 1024) { alert(`${file.name} es muy grande (máx 20MB)`); continue; }
    if (file.type.startsWith('image/') && !SUPPORTED_IMAGES.includes(file.type)) {
      alert(`${file.name}: formato ${file.type} no soportado. Usá JPG, PNG, GIF o WebP.`);
      continue;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      pendingFiles.push({
        name: file.name,
        type: file.type,
        dataUrl: reader.result,
        base64: base64,
        isImage: file.type.startsWith('image/'),
      });
      renderAttachPreview();
      toggleSend();
    };
    reader.readAsDataURL(file);
  }
  document.getElementById('fileInput').value = '';
  document.getElementById('input').focus();
}

function removeFile(idx) {
  pendingFiles.splice(idx, 1);
  renderAttachPreview();
  toggleSend();
}

function renderAttachPreview() {
  const container = document.getElementById('attachPreview');
  container.innerHTML = pendingFiles.map((f, i) => {
    if (f.isImage) {
      return `<div class="attach-item">
        <img src="${f.dataUrl}" alt="${esc(f.name)}">
        <button class="attach-remove" onclick="removeFile(${i})">×</button>
      </div>`;
    }
    return `<div class="attach-item">
      <div class="attach-file">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span>${esc(f.name)}</span>
      </div>
      <button class="attach-remove" onclick="removeFile(${i})">×</button>
    </div>`;
  }).join('');
}

// ─── MARKDOWN ───
function md(text) {
  return text
    .replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) =>
      `<pre><code>${esc(code.trim())}</code><button class="msg-action-btn copy-code" onclick="copyCode(this)" title="Copiar código"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^### (.+)$/gm, '<strong style="font-size:15px">$1</strong>')
    .replace(/^## (.+)$/gm, '<strong style="font-size:16px">$1</strong>')
    .replace(/^# (.+)$/gm, '<strong style="font-size:18px">$1</strong>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^[-*] (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>')
    .replace(/<p><\/p>/g, '')
    .replace(/<ul><\/ul>/g, '');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ─── RENDER MESSAGES ───
function renderMessages() {
  const inner = document.getElementById('messagesInner');
  const chat = activeChat();
  if (!chat || chat.messages.length === 0) {
    inner.innerHTML = `<div class="welcome" id="welcome">
      <div class="welcome-logo">R</div>
      <div class="welcome-title">¿En qué puedo ayudarte?</div>
      <div class="welcome-sub">Escribí lo que necesites.</div>
    </div>`;
    return;
  }
  inner.innerHTML = chat.messages.map((m, i) => {
    if (m.role === 'user') {
      let attachHtml = '';
      if (m.attachments && m.attachments.length) {
        attachHtml = '<div class="msg-attachments">' + m.attachments.map(a => {
          if (a.isImage) return `<img class="msg-img" src="${a.dataUrl}" alt="${esc(a.name)}" onclick="window.open(this.src)">`;
          return `<div class="msg-file"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="16" height="16"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>${esc(a.name)}</div>`;
        }).join('') + '</div>';
      }
      const textHtml = m.content && m.content !== '(archivo adjunto)' ? `<div class="msg-content">${esc(m.content)}</div>` : '';
      return `<div class="message user">${attachHtml}${textHtml}</div>`;
    }
    return `<div class="message assistant">
      <div class="msg-avatar">R</div>
      <div class="msg-body">
        <div class="msg-content">${md(m.content)}</div>
        <div class="msg-actions">
          <button class="msg-action-btn" onclick="copyMsg(this, ${i})" title="Copiar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          </button>
        </div>
      </div>
    </div>`;
  }).join('');
  scrollBottom();
}

// ─── SEND ───
async function sendMessage() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if ((!text && !pendingFiles.length) || isGenerating) return;

  if (!activeChatId) newChat();
  const chat = activeChat();

  const msg = { role: 'user', content: text || '(archivo adjunto)' };
  if (pendingFiles.length) {
    msg.attachments = pendingFiles.map(f => ({
      name: f.name, type: f.type, base64: f.base64, dataUrl: f.dataUrl, isImage: f.isImage,
    }));
  }
  chat.messages.push(msg);
  if (!chat.title) chat.title = (text || pendingFiles[0]?.name || 'Nuevo chat').slice(0, 40);

  const filesToSend = [...pendingFiles];
  pendingFiles = [];
  renderAttachPreview();
  save(); renderSidebar(); renderMessages();

  input.value = ''; autoGrow(input); toggleSend();
  isGenerating = true;

  const inner = document.getElementById('messagesInner');
  const thinkDiv = document.createElement('div');
  thinkDiv.className = 'message assistant';
  thinkDiv.innerHTML = `
    <div class="msg-avatar">R</div>
    <div class="msg-body"><div class="msg-content">
      <div class="thinking"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div><span class="thinking-text" id="thinkingText"></span></div>
    </div></div>`;
  inner.appendChild(thinkDiv);
  scrollBottom();

  try {
    const response = await callAPI(chat.messages, filesToSend, (status) => {
      const tt = document.getElementById('thinkingText');
      if (tt) tt.textContent = status;
    });
    thinkDiv.remove();
    if (response !== null) {
      chat.messages.push({ role: 'assistant', content: response });
      save(); renderMessages();
    } else {
      save();
    }
  } catch (err) {
    thinkDiv.remove();
    chat.messages.push({ role: 'assistant', content: `Error: ${err.message}` });
    save(); renderMessages();
  }
  isGenerating = false;
}

// ─── API ───
async function callAPI(messages, files, onStatus) {
  try {
    const lastMsg = messages[messages.length - 1];
    const hasFiles = lastMsg.attachments?.length > 0;
    if (hasFiles) onStatus?.('Procesando archivo...');
    else onStatus?.('Pensando...');

    const payload = {
      messages: messages.map((m, i) => ({
        role: m.role,
        content: m.content,
        attachments: m.attachments?.map(a => ({
          name: a.name,
          type: a.type,
          base64: i === messages.length - 1 ? a.base64 : undefined,
        })),
      })),
    };

    // Timer para cambiar estado si tarda
    const searchTimer = setTimeout(() => onStatus?.('Procesando...'), 5000);

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    clearTimeout(searchTimer);

    onStatus?.('Generando respuesta...');
    const data = await res.json();
    if (res.ok) {
      if (data.model) updateModelInfo(data.model, data.key);

      // Gemini quiere ejecutar un comando → pedir confirmación
      if (data.needs_confirmation) {
        return await showCommandConfirmation(data.command, messages, onStatus);
      }

      let text = data.text || data.response || data.message || 'Sin respuesta';
      if (data.sources && data.sources.length) {
        text += '\n\n---\n**Fuentes:**\n' + data.sources.map(s =>
          `- [${s.title || s.url}](${s.url})`
        ).join('\n');
      }
      return text;
    }
    return `⚠️ ${data.error || 'Error del servidor'}. Esperá unos segundos y volvé a intentar.`;
  } catch (e) { /* backend not available */ }

  return "Backend no disponible. Iniciá el server con `pm2 start renzogpt`.";
}

// ─── COMMAND CONFIRMATION ───
function showCommandConfirmation(command, messages, onStatus) {
  return new Promise((resolve) => {
    const inner = document.getElementById('messagesInner');
    // Quitar el thinking indicator temporalmente
    const thinking = inner.querySelector('.thinking');
    if (thinking) thinking.closest('.message')?.remove();

    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'message assistant';
    const confirmId = 'cmd-' + Date.now();
    confirmDiv.innerHTML = `
      <div class="msg-avatar">R</div>
      <div class="msg-body">
        <div class="cmd-confirm">
          <div class="cmd-confirm-title">RenzoGPT quiere ejecutar:</div>
          <div class="cmd-confirm-code">$ ${esc(command)}</div>
          <div class="cmd-confirm-btns" id="${confirmId}">
            <button class="cmd-btn cmd-btn-exec" id="${confirmId}-exec">Ejecutar</button>
            <button class="cmd-btn cmd-btn-cancel" id="${confirmId}-cancel">Cancelar</button>
          </div>
        </div>
      </div>`;
    inner.appendChild(confirmDiv);
    scrollBottom();

    document.getElementById(`${confirmId}-exec`).onclick = async () => {
      const btnsDiv = document.getElementById(confirmId);
      btnsDiv.innerHTML = '<span style="color:var(--text-muted);font-size:13px;font-style:italic">Ejecutando...</span>';

      try {
        const execRes = await fetch('/api/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command }),
        });
        const execData = await execRes.json();

        if (execData.command_output) {
          const outputDiv = document.createElement('div');
          outputDiv.className = 'cmd-output';
          outputDiv.textContent = execData.command_output;
          confirmDiv.querySelector('.cmd-confirm').appendChild(outputDiv);
        }
        btnsDiv.remove();
        scrollBottom();

        resolve(null);
      } catch (e) {
        btnsDiv.innerHTML = '<span style="color:#ef4444;font-size:13px">Error al ejecutar</span>';
        resolve(null);
      }
    };

    document.getElementById(`${confirmId}-cancel`).onclick = () => {
      const btnsDiv = document.getElementById(confirmId);
      btnsDiv.innerHTML = '<span style="color:var(--text-muted);font-size:13px">Cancelado</span>';
      resolve('Dale, cancelado. No ejecuté nada.');
    };
  });
}

// ─── UTILS ───
function autoGrow(el) {
  el.style.height = '24px';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}
function toggleSend() {
  const btn = document.getElementById('sendBtn');
  const hasContent = document.getElementById('input').value.trim().length > 0 || pendingFiles.length > 0;
  btn.classList.toggle('active', hasContent);
}
function scrollBottom() {
  const m = document.getElementById('messages');
  requestAnimationFrame(() => m.scrollTop = m.scrollHeight);
}
function copyMsg(btn, idx) {
  const chat = activeChat();
  if (!chat) return;
  navigator.clipboard.writeText(chat.messages[idx].content);
  btn.classList.add('copied');
  btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 6L9 17l-5-5"/></svg>';
  setTimeout(() => {
    btn.classList.remove('copied');
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';
  }, 2000);
}
function updateModelInfo(model, key) {
  document.getElementById('modelInfo').textContent = `Modelo: ${model} · Key ${key}`;
}
function copyCode(btn) {
  const code = btn.parentElement.querySelector('code').textContent;
  navigator.clipboard.writeText(code);
  btn.classList.add('copied');
  setTimeout(() => btn.classList.remove('copied'), 2000);
}

// ─── STATUS PANEL ───
let statusOpen = false;

function toggleStatus() {
  statusOpen = !statusOpen;
  document.getElementById('statusPanel').classList.toggle('open', statusOpen);
  document.getElementById('statusToggle').classList.toggle('open', statusOpen);
  if (statusOpen) pollStatus();
}

async function pollStatus() {
  try {
    const res = await fetch('/api/status');
    if (!res.ok) return;
    const data = await res.json();
    renderStatus(data);
  } catch {}
}

function renderStatus(data) {
  const grid = document.getElementById('statusGrid');
  let html = '';
  for (const c of data.combos) {
    const rpdLeft = c.rpd_limit - c.rpd_used;
    let dot = 'green';
    let detail = '';

    if (rpdLeft <= 0) {
      dot = 'red';
      detail = 'agotada';
    } else if (c.rpm_wait > 0) {
      dot = 'yellow';
      detail = `${c.rpm_wait}s`;
    } else {
      detail = `${c.rpd_used}/${c.rpd_limit}`;
    }

    const shortModel = c.model.replace('gemini-', '').replace('-preview', '');

    html += `<span class="status-pill">` +
      `<span class="status-dot ${dot}"></span>` +
      `<span class="s-model">K${c.key} ${shortModel}</span>` +
      `<span class="s-detail">${detail}</span>` +
      `</span>`;
  }
  grid.innerHTML = html;
}

// Pollear cada 5s
pollStatus();
setInterval(pollStatus, 5000);

init();
</script>
</body>
</html>
