<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lola · Configurá tu bot</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1114;
  --surface:#1b1f23;
  --border:rgba(255,255,255,.08);
  --text:#f0f0f0;
  --text-dim:#9ca3af;
  --text-muted:#6b7280;
  --green:#25D366;
  --green-dark:#128C7E;
}
html,body{height:100%;overflow:hidden}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;align-items:center;justify-content:center;
}

/* ─── LANDING ─── */
.landing{
  text-align:center;
  animation:fadeUp .6s cubic-bezier(.16,1,.3,1) forwards;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(16px)}
  to{opacity:1;transform:translateY(0)}
}
.landing-logo{
  width:80px;height:80px;border-radius:22px;
  background:linear-gradient(135deg,var(--green) 0%,var(--green-dark) 100%);
  display:flex;align-items:center;justify-content:center;
  font-size:34px;font-weight:700;color:#fff;
  margin:0 auto 24px;
  box-shadow:0 8px 32px rgba(37,211,102,.25);
}
.landing h1{
  font-size:28px;font-weight:700;letter-spacing:-.5px;
  margin-bottom:8px;
}
.landing p{
  color:var(--text-dim);font-size:15px;
  margin-bottom:36px;line-height:1.6;
  max-width:340px;
}
.landing-btn{
  display:inline-flex;align-items:center;gap:10px;
  background:linear-gradient(135deg,var(--green) 0%,#20BD5A 100%);
  color:#000;border:none;border-radius:16px;
  padding:16px 36px;font-size:16px;font-weight:600;
  font-family:inherit;cursor:pointer;letter-spacing:-.2px;
  box-shadow:0 4px 20px rgba(37,211,102,.25);
  transition:all .25s cubic-bezier(.16,1,.3,1);
}
.landing-btn:hover{
  box-shadow:0 8px 32px rgba(37,211,102,.4);
  transform:translateY(-2px);
}
.landing-btn:active{
  transform:translateY(0);
  box-shadow:0 2px 12px rgba(37,211,102,.2);
}
.landing-btn svg{width:20px;height:20px;flex-shrink:0}

/* ─── LOLA ONBOARDING ─── */
.lola-overlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,0);backdrop-filter:blur(0px);
  align-items:center;justify-content:center;
  transition:background .35s ease,backdrop-filter .35s ease;
}
.lola-overlay.show{
  display:flex;
  background:rgba(0,0,0,.7);backdrop-filter:blur(12px);
}
.lola-modal{
  background:linear-gradient(168deg,#1b1f23 0%,#141618 100%);
  border:1px solid rgba(255,255,255,.08);
  border-radius:24px;
  width:420px;max-width:92vw;max-height:90vh;overflow:hidden;
  box-shadow:0 32px 80px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.04) inset,0 1px 0 rgba(255,255,255,.06) inset;
  transform:translateY(20px) scale(.97);opacity:0;
  animation:lolaModalIn .4s cubic-bezier(.16,1,.3,1) forwards;
}
@keyframes lolaModalIn{
  to{transform:translateY(0) scale(1);opacity:1}
}
.lola-modal-header{
  padding:20px 24px 16px;
  border-bottom:1px solid rgba(255,255,255,.06);
  display:flex;align-items:center;gap:14px;
  background:rgba(255,255,255,.02);
}
.lola-modal-header .lola-avatar{
  width:40px;height:40px;border-radius:14px;
  background:linear-gradient(135deg,#25D366 0%,#128C7E 100%);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:16px;color:#fff;flex-shrink:0;
  box-shadow:0 4px 12px rgba(37,211,102,.25);
}
.lola-modal-header .lola-title{
  font-size:16px;font-weight:600;letter-spacing:-.2px;color:#f0f0f0;
}
.lola-modal-header .lola-sub{
  font-size:12px;color:#6b7280;margin-top:1px;
  transition:color .2s;
}
.lola-close{
  margin-left:auto;padding:8px;border-radius:10px;
  color:#6b7280;transition:all .2s;
  cursor:pointer;border:none;background:none;
}
.lola-close:hover{background:rgba(255,255,255,.08);color:#d1d5db}
.lola-body{padding:28px 24px 24px}
.lola-step{
  display:none;
  animation:lolaStepIn .35s cubic-bezier(.16,1,.3,1) forwards;
}
.lola-step.active{display:block}
@keyframes lolaStepIn{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}
.lola-label{
  font-size:14px;color:#9ca3af;margin-bottom:20px;line-height:1.6;
}
.lola-input-row{display:flex;gap:10px;margin-bottom:8px}
.lola-input{
  flex:1;background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);
  border-radius:14px;padding:14px 16px;color:#f0f0f0;
  font-size:15px;font-family:inherit;outline:none;
  transition:border-color .2s,box-shadow .2s,background .2s;
}
.lola-input:focus{
  border-color:rgba(37,211,102,.5);
  box-shadow:0 0 0 3px rgba(37,211,102,.1);
  background:rgba(255,255,255,.07);
}
.lola-input::placeholder{color:#4b5563}
.lola-btn{
  background:linear-gradient(135deg,#25D366 0%,#20BD5A 100%);
  color:#000;border:none;border-radius:14px;
  padding:14px 24px;font-size:14px;font-weight:600;font-family:inherit;
  cursor:pointer;transition:all .25s cubic-bezier(.16,1,.3,1);
  white-space:nowrap;letter-spacing:-.2px;
  box-shadow:0 2px 8px rgba(37,211,102,.2);
}
.lola-btn:hover{
  box-shadow:0 8px 24px rgba(37,211,102,.3);
  transform:translateY(-2px);
}
.lola-btn:active{transform:translateY(0);box-shadow:0 2px 8px rgba(37,211,102,.2)}
.lola-btn:disabled{
  opacity:.35;cursor:not-allowed;transform:none;
  box-shadow:none;filter:grayscale(.3);
}
.lola-error{
  color:#f87171;font-size:12.5px;margin-top:10px;min-height:18px;
  padding-left:2px;
}
.lola-otp-row{
  display:flex;gap:10px;justify-content:center;margin-bottom:22px;
}
.lola-otp-digit{
  width:48px;height:58px;
  background:rgba(255,255,255,.04);
  border:1.5px solid rgba(255,255,255,.1);
  border-radius:14px;color:#f0f0f0;font-size:24px;
  font-family:'SF Mono','Menlo',monospace;font-weight:500;
  text-align:center;outline:none;
  transition:all .2s cubic-bezier(.16,1,.3,1);
}
.lola-otp-digit:focus{
  border-color:#25D366;
  box-shadow:0 0 0 3px rgba(37,211,102,.15);
  background:rgba(37,211,102,.05);
  transform:translateY(-2px);
}
.lola-back{
  background:none;border:none;color:#6b7280;font-size:13px;
  cursor:pointer;font-family:inherit;padding:0;margin-top:14px;
  transition:color .2s;
}
.lola-back:hover{color:#d1d5db}

/* ── Onboarding chat ── */
.lola-chat-wrap{
  background:#0b141a;border-radius:16px;overflow:hidden;
  border:1px solid rgba(255,255,255,.06);
  box-shadow:0 8px 32px rgba(0,0,0,.3) inset;
}
.lola-chat-msgs{
  padding:16px;min-height:320px;max-height:320px;overflow-y:auto;
  display:flex;flex-direction:column;gap:8px;
  background-image:url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.015'%3E%3Cpath d='M20 20h20v20H20z'/%3E%3Cpath d='M0 0h20v20H0z'/%3E%3C/g%3E%3C/svg%3E");
}
.lola-chat-msg{
  max-width:85%;padding:10px 14px;border-radius:12px;
  font-size:13.5px;line-height:1.5;
  animation:lolaMsg .3s cubic-bezier(.16,1,.3,1) forwards;
}
@keyframes lolaMsg{
  from{opacity:0;transform:translateY(6px) scale(.98)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.lola-chat-msg.sent{
  background:linear-gradient(135deg,#005c4b,#00503f);
  align-self:flex-end;border-bottom-right-radius:4px;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}
.lola-chat-msg.received{
  background:#1f2c34;
  align-self:flex-start;border-bottom-left-radius:4px;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
}
.lola-chat-msg .time{
  font-size:10px;color:rgba(255,255,255,.35);
  float:right;margin-left:10px;margin-top:5px;
}
.lola-chat-typing{
  align-self:flex-start;background:#1f2c34;
  padding:12px 16px;border-radius:12px;border-bottom-left-radius:4px;
  display:none;gap:5px;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
}
.lola-chat-typing.show{display:flex}
.lola-chat-typing span{
  width:6px;height:6px;background:#5b6e7a;border-radius:50%;
  animation:lolaBounce 1.4s infinite;
}
.lola-chat-typing span:nth-child(2){animation-delay:.2s}
.lola-chat-typing span:nth-child(3){animation-delay:.4s}
@keyframes lolaBounce{
  0%,60%,100%{transform:translateY(0);opacity:.35}
  30%{transform:translateY(-4px);opacity:1}
}
.lola-chat-input{
  display:flex;align-items:center;gap:10px;padding:12px 14px;
  background:rgba(31,44,52,.8);
  border-top:1px solid rgba(255,255,255,.04);
  flex-wrap:wrap;
}
.lola-file-preview{
  display:none;width:100%;order:-1;
  padding:6px 10px;margin-bottom:2px;
  background:rgba(255,255,255,.06);border-radius:10px;
  font-size:12px;color:#9ca3af;
  align-items:center;gap:8px;
}
.lola-file-preview.show{display:flex}
.lola-file-preview .fname{
  flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.lola-file-preview .fremove{
  background:none;border:none;color:#6b7280;cursor:pointer;
  font-size:16px;line-height:1;padding:2px 4px;border-radius:6px;
  transition:color .2s,background .2s;
}
.lola-file-preview .fremove:hover{color:#f87171;background:rgba(248,113,113,.1)}
.lola-clip{
  width:30px;height:30px;
  background:none;border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;color:#5b6e7a;
  border-radius:50%;transition:color .2s,background .2s;
}
.lola-clip:hover{color:#9ca3af;background:rgba(255,255,255,.08)}
.lola-chat-input input{
  flex:1;background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.06);
  border-radius:24px;
  padding:10px 16px;color:#e8e8e8;font-size:13.5px;font-family:inherit;outline:none;
  transition:border-color .2s,background .2s;
}
.lola-chat-input input:focus{
  border-color:rgba(37,211,102,.3);
  background:rgba(255,255,255,.1);
}
.lola-chat-input input::placeholder{color:#5b6e7a}
.lola-chat-send{
  width:34px;height:34px;
  background:linear-gradient(135deg,#25D366,#20BD5A);
  border-radius:50%;border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;
  transition:all .2s cubic-bezier(.16,1,.3,1);
  box-shadow:0 2px 8px rgba(37,211,102,.25);
}
.lola-chat-send:hover{transform:scale(1.08);box-shadow:0 4px 16px rgba(37,211,102,.35)}
.lola-chat-send:active{transform:scale(.95)}

/* ── Complete step ── */
.lola-complete{text-align:center;padding:24px 0 8px}
.lola-check{
  width:64px;height:64px;border-radius:50%;
  background:radial-gradient(circle at 40% 40%,rgba(37,211,102,.2),rgba(37,211,102,.05));
  border:2px solid rgba(37,211,102,.4);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 20px;font-size:28px;color:#25D366;
  animation:lolaCheckPop .5s cubic-bezier(.16,1,.3,1) forwards;
  box-shadow:0 0 40px rgba(37,211,102,.15);
}
@keyframes lolaCheckPop{
  0%{transform:scale(0);opacity:0}
  60%{transform:scale(1.15)}
  100%{transform:scale(1);opacity:1}
}
.lola-complete h3{
  font-size:19px;margin-bottom:10px;font-weight:600;
  letter-spacing:-.3px;color:#f0f0f0;
}
.lola-complete p{
  color:#9ca3af;font-size:14px;line-height:1.65;
  max-width:320px;margin:0 auto;
}

/* ── Scrollbar ── */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#424242;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#555}

/* ── Mobile ── */
@media(max-width:480px){
  .landing h1{font-size:24px}
  .landing p{font-size:14px}
  .landing-btn{padding:14px 28px;font-size:15px}
  .lola-modal{border-radius:20px;width:96vw}
  .lola-body{padding:20px 18px 18px}
  .lola-otp-digit{width:42px;height:50px;font-size:20px;border-radius:12px}
  .lola-otp-row{gap:6px}
  .lola-chat-msgs{min-height:260px;max-height:260px}
}
</style>
</head>
<body>

<!-- LANDING -->
<div class="landing">
  <div class="landing-logo">L</div>
  <h1>Lola</h1>
  <p>Tu asistente de WhatsApp para tu negocio. Configurala en minutos.</p>
  <button class="landing-btn" onclick="openLolaConfig()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    Configurar mi Lola
  </button>
</div>

<!-- LOLA ONBOARDING MODAL -->
<div class="lola-overlay" id="lolaOverlay">
  <div class="lola-modal">
    <div class="lola-modal-header">
      <div class="lola-avatar">L</div>
      <div>
        <div class="lola-title">Configurar mi Lola</div>
        <div class="lola-sub" id="lolaHeaderSub">Verificá tu suscripción</div>
      </div>
      <button class="lola-close" onclick="closeLolaConfig()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="lola-body">
      <!-- Step 1: Phone -->
      <div class="lola-step active" id="lolaStepPhone">
        <p class="lola-label">Ingresá el número de WhatsApp con el que te suscribiste. Te mandamos un código de verificación.</p>
        <div class="lola-input-row">
          <input type="tel" class="lola-input" id="lolaPhone" placeholder="099 123 456" autocomplete="tel">
          <button class="lola-btn" id="lolaSendOtp">Enviar</button>
        </div>
        <div class="lola-error" id="lolaPhoneErr"></div>
      </div>
      <!-- Step 2: OTP -->
      <div class="lola-step" id="lolaStepOtp">
        <p class="lola-label">Ingresá el código de 6 dígitos que te mandamos por WhatsApp.</p>
        <div class="lola-otp-row" id="lolaOtpRow">
          <input type="text" class="lola-otp-digit" maxlength="1" inputmode="numeric">
          <input type="text" class="lola-otp-digit" maxlength="1" inputmode="numeric">
          <input type="text" class="lola-otp-digit" maxlength="1" inputmode="numeric">
          <input type="text" class="lola-otp-digit" maxlength="1" inputmode="numeric">
          <input type="text" class="lola-otp-digit" maxlength="1" inputmode="numeric">
          <input type="text" class="lola-otp-digit" maxlength="1" inputmode="numeric">
        </div>
        <button class="lola-btn" id="lolaVerifyOtp" style="width:100%" disabled>Verificar</button>
        <div class="lola-error" id="lolaOtpErr"></div>
        <button class="lola-back" id="lolaBackPhone">Cambiar número</button>
      </div>
      <!-- Step 3: Onboarding chat -->
      <div class="lola-step" id="lolaStepChat">
        <div class="lola-chat-wrap">
          <div class="lola-chat-msgs" id="lolaChatMsgs">
            <div class="lola-chat-typing" id="lolaChatTyping"><span></span><span></span><span></span></div>
          </div>
          <form class="lola-chat-input" id="lolaChatForm" autocomplete="off">
            <div class="lola-file-preview" id="lolaFilePreview">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <span class="fname" id="lolaFileName"></span>
              <button type="button" class="fremove" id="lolaFileRemove">&times;</button>
            </div>
            <input type="file" id="lolaFileInput" hidden accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.csv,.txt,.xls,.xlsx">
            <button type="button" class="lola-clip" id="lolaClipBtn" title="Adjuntar archivo">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
            </button>
            <input type="text" id="lolaChatInput" placeholder="Escribile a Lola..." autocomplete="off">
            <button type="submit" class="lola-chat-send">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="#0b141a"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </form>
        </div>
      </div>
      <!-- Step 4: Complete -->
      <div class="lola-step" id="lolaStepDone">
        <div class="lola-complete">
          <div class="lola-check">&#10003;</div>
          <h3>Tu Lola está lista</h3>
          <p>Configuramos todo con la info que nos diste. Cuando conectemos Lola a tu WhatsApp Business, va a empezar a atender a tus clientes.</p>
          <p style="color:#25D366;margin-top:12px">Te contactamos pronto para los últimos pasos.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ─── LOLA ONBOARDING ───
const LOLA_TOKEN_KEY = 'lola_auth_token';
const LOLA_PHONE_KEY = 'lola_auth_phone';
let lolaToken = localStorage.getItem(LOLA_TOKEN_KEY) || '';
let lolaPhone = localStorage.getItem(LOLA_PHONE_KEY) || '';
let lolaSending = false;
let lolaFile = null; // {name, type, base64}
const LOLA_MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

function openLolaConfig() {
  document.getElementById('lolaOverlay').classList.add('show');
  if (lolaToken) {
    restoreLolaSession();
  } else {
    lolaShowStep('lolaStepPhone');
    document.getElementById('lolaPhone').focus();
  }
}

function closeLolaConfig() {
  document.getElementById('lolaOverlay').classList.remove('show');
}

function lolaShowStep(id) {
  document.querySelectorAll('.lola-step').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const subs = {lolaStepPhone:'Verificá tu suscripción',lolaStepOtp:'Ingresá el código',lolaStepChat:'Configurando tu bot',lolaStepDone:'Listo!'};
  document.getElementById('lolaHeaderSub').textContent = subs[id] || '';
  if (id === 'lolaStepOtp') {
    lolaDigits.forEach(d => d.value = '');
    document.getElementById('lolaVerifyOtp').disabled = true;
    document.getElementById('lolaOtpErr').textContent = '';
  }
}

function lolaTime() {
  const d = new Date();
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}

function lolaAddMsg(text, type) {
  const msgs = document.getElementById('lolaChatMsgs');
  const typing = document.getElementById('lolaChatTyping');
  const div = document.createElement('div');
  div.className = 'lola-chat-msg ' + type;
  div.innerHTML = text + ' <span class="time">' + lolaTime() + '</span>';
  msgs.insertBefore(div, typing);
  msgs.scrollTop = msgs.scrollHeight;
}

// Send OTP
document.getElementById('lolaSendOtp').addEventListener('click', async () => {
  const phone = document.getElementById('lolaPhone').value.trim();
  const errEl = document.getElementById('lolaPhoneErr');
  if (!phone) { errEl.textContent = 'Ingresá tu número'; return; }
  errEl.textContent = '';
  const btn = document.getElementById('lolaSendOtp');
  btn.disabled = true; btn.textContent = 'Enviando...';
  try {
    const r = await fetch('/api/auth/send-otp', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({phone}),
    });
    const d = await r.json();
    if (d.ok) {
      lolaPhone = phone;
      localStorage.setItem(LOLA_PHONE_KEY, phone);
      lolaShowStep('lolaStepOtp');
      document.querySelectorAll('.lola-otp-digit')[0].focus();
    } else {
      errEl.textContent = d.error || 'Error';
    }
  } catch(e) { errEl.textContent = 'Error de conexión'; }
  btn.disabled = false; btn.textContent = 'Enviar';
});

document.getElementById('lolaPhone').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); document.getElementById('lolaSendOtp').click(); }
});

// OTP digits
const lolaDigits = document.querySelectorAll('.lola-otp-digit');
lolaDigits.forEach((inp, idx) => {
  inp.addEventListener('input', e => {
    const v = e.target.value.replace(/\D/g,'');
    e.target.value = v.slice(0,1);
    if (v && idx < lolaDigits.length - 1) lolaDigits[idx+1].focus();
    const code = Array.from(lolaDigits).map(d=>d.value).join('');
    document.getElementById('lolaVerifyOtp').disabled = code.length < 6;
  });
  inp.addEventListener('keydown', e => {
    if (e.key === 'Backspace' && !e.target.value && idx > 0) lolaDigits[idx-1].focus();
  });
  inp.addEventListener('paste', e => {
    e.preventDefault();
    const p = (e.clipboardData.getData('text')||'').replace(/\D/g,'').slice(0,6);
    p.split('').forEach((ch,i) => { if(lolaDigits[i]) lolaDigits[i].value = ch; });
    if (p.length===6) { document.getElementById('lolaVerifyOtp').disabled = false; document.getElementById('lolaVerifyOtp').focus(); }
  });
});

// Verify OTP
document.getElementById('lolaVerifyOtp').addEventListener('click', async () => {
  const code = Array.from(lolaDigits).map(d=>d.value).join('');
  if (code.length < 6) return;
  const errEl = document.getElementById('lolaOtpErr');
  errEl.textContent = '';
  const btn = document.getElementById('lolaVerifyOtp');
  btn.disabled = true; btn.textContent = 'Verificando...';
  try {
    const r = await fetch('/api/auth/verify-otp', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({phone: lolaPhone, code}),
    });
    const d = await r.json();
    if (d.ok) {
      lolaToken = d.token;
      localStorage.setItem(LOLA_TOKEN_KEY, lolaToken);
      if (d.onboarding_complete) {
        lolaShowStep('lolaStepDone');
      } else {
        startLolaOnboarding();
      }
    } else {
      errEl.textContent = d.error || 'Código incorrecto';
      lolaDigits.forEach(d=>d.value='');
      lolaDigits[0].focus();
    }
  } catch(e) { errEl.textContent = 'Error de conexión'; }
  btn.disabled = false; btn.textContent = 'Verificar';
});

// Back
document.getElementById('lolaBackPhone').addEventListener('click', () => {
  lolaDigits.forEach(d=>d.value='');
  document.getElementById('lolaOtpErr').textContent = '';
  lolaShowStep('lolaStepPhone');
  document.getElementById('lolaPhone').focus();
});

// Onboarding chat
function startLolaOnboarding() {
  lolaShowStep('lolaStepChat');
  setTimeout(() => {
    document.getElementById('lolaChatTyping').classList.add('show');
    sendLolaMsg('hola', true, true);
  }, 500);
}

async function sendLolaMsg(text, hideUser, reset) {
  if (lolaSending) return;
  lolaSending = true;
  // Capture and clear attached file before sending
  const currentFile = lolaFile;
  if (currentFile && !hideUser) {
    lolaAddMsg(text + ' <span style="opacity:.5;font-size:11px"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:2px"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>' + currentFile.name + '</span>', 'sent');
  } else if (!hideUser) {
    lolaAddMsg(text, 'sent');
  }
  lolaFile = null;
  document.getElementById('lolaFileInput').value = '';
  document.getElementById('lolaFilePreview').classList.remove('show');
  const typing = document.getElementById('lolaChatTyping');
  const msgs = document.getElementById('lolaChatMsgs');
  typing.classList.add('show');
  msgs.scrollTop = msgs.scrollHeight;
  try {
    const payload = {message: text, token: lolaToken};
    if (currentFile) payload.attachments = [currentFile];
    if (reset) payload.reset = true;
    const r = await fetch('/api/lola-chat', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload),
    });
    const d = await r.json();
    typing.classList.remove('show');
    if (d.text) {
      const chunks = d.text.split('\n').map(c=>c.trim()).filter(c=>c);
      for (let j=0; j<chunks.length; j++) {
        if (j > 0) {
          typing.classList.add('show');
          msgs.scrollTop = msgs.scrollHeight;
          await new Promise(r => setTimeout(r, 700));
          typing.classList.remove('show');
        }
        lolaAddMsg(chunks[j], 'received');
      }
      if (d.onboarding_complete) {
        setTimeout(() => lolaShowStep('lolaStepDone'), 2000);
      }
    } else {
      lolaAddMsg('Uy, tuve un problema. Proba de nuevo.', 'received');
    }
  } catch(e) {
    typing.classList.remove('show');
    lolaAddMsg('No me pude conectar, proba de nuevo.', 'received');
  }
  lolaSending = false;
}

document.getElementById('lolaChatForm').addEventListener('submit', e => {
  e.preventDefault();
  const inp = document.getElementById('lolaChatInput');
  const text = inp.value.trim();
  if ((!text && !lolaFile) || lolaSending) return;
  inp.value = '';
  sendLolaMsg(text || '(archivo adjunto)', false);
});

// Restore session on page load
async function restoreLolaSession() {
  try {
    const r = await fetch('/api/auth/session', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({token: lolaToken}),
    });
    const d = await r.json();
    if (d.ok) {
      if (d.onboarding_complete) lolaShowStep('lolaStepDone');
      else startLolaOnboarding();
    } else {
      localStorage.removeItem(LOLA_TOKEN_KEY);
      lolaToken = '';
      lolaShowStep('lolaStepPhone');
      document.getElementById('lolaPhone').focus();
    }
  } catch(e) {
    lolaShowStep('lolaStepPhone');
  }
}

// ─── FILE ATTACHMENT ───
document.getElementById('lolaClipBtn').addEventListener('click', () => {
  document.getElementById('lolaFileInput').click();
});

document.getElementById('lolaFileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > LOLA_MAX_FILE_SIZE) {
    alert('El archivo es muy grande (máximo 10MB)');
    e.target.value = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    const b64 = reader.result.split(',')[1];
    lolaFile = {name: file.name, type: file.type || 'application/octet-stream', base64: b64};
    document.getElementById('lolaFileName').textContent = file.name;
    document.getElementById('lolaFilePreview').classList.add('show');
  };
  reader.readAsDataURL(file);
});

document.getElementById('lolaFileRemove').addEventListener('click', () => {
  lolaFile = null;
  document.getElementById('lolaFileInput').value = '';
  document.getElementById('lolaFilePreview').classList.remove('show');
});

// Close on overlay click
document.getElementById('lolaOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeLolaConfig();
});
</script>
</body>
</html>
